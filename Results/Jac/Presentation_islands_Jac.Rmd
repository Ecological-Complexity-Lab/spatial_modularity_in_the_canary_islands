---
title: Drivers of structure distance decay in a spatial multilayer plant-pollinator
  network
output:
  html_document:
    toc: yes
    toc_float: yes
    collapse: no
    number_sections: yes
    code_folding: hide
    theme: united
    highlight: tango
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "asis", message=FALSE, warning=FALSE, cache=TRUE, eval = TRUE, dev = c('png'), out.width = '100%', out.height='40%')
```


```{r load libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(infomapecology)
library(igraph)
library(bipartite)
library(tidyverse)
library(magrittr)
library(betalink)
library(readxl)
library(ggalluvial)
library(scatterpie)
library(reshape2)
library(ggforce)
library(ggmap)
library(ggraph)
library(ggpubr)
rm(list=ls())
```

\
\
\

# Distance decay
A well-documented phenomenon in nature is distance decayâ€” the decreasing species similarity between two locations
as the distance between them increase. However, studies addressing distance decay in community structure are rare. 
\
\
\

# Goal
We studied how distance affects the modular structure of a multilayer plant-pollinator network in the Canary Islands. In addition, we performed null models that explicitly control different components to disentangle the mechanisms behind distance decay patterns.
\
\
\

# Methods
\

## Data
\
The study was conducted in The Canary Islands, where six islands and one location on the mainland were sampled. Distances between locations ranged from 52 to 450 kilometers. On each location, pollinator-plant interactions were recorded in two adjacent sites (from 50 to 500 meters apart) for a total of 14 sites. We aggregated data from any two adjacent sites on an island or mainland because we were interested in between-location spatial scale. 

```{r}
library(knitr)
Description <- read_excel("Location_description.xlsx")
kable(Description, align=c(rep('c',times=7)))

```
\
\
\

\

## Plant-pollinator multilayer network {.tabset}

Contained four components:

1. Seven layers (six islands and the mainland).

2. Two sets of nodes representing pollinator and plant species.

3. Intralayer directed weighted links representing pollinator-plant interactions within layers.

4. Interlayer weighted links connecting any species i to itself between two layers when they shared at least one partner. Greater values indicate higher similarity between the same species across locations. 
\
\
\

### Information of layers
\
\
```{r}
library(knitr)
Description <- read_excel("Location_description.xlsx", sheet = 2)
kable(Description, align=c(rep('c',times=7)))
```
\
\
\
\
\

### Distribution of intra and interlayer links
\
\
```{r}

intra_inter_data_for_distibution <- read.csv("intra_inter_data_for_distibution_islands_as_layers.csv")

intra_inter_data_for_distibution %>%
  ggplot(aes(x=values, fill=group))+ geom_histogram(position= "identity", alpha= 0.6, color= "black")+ theme_bw()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=14, color='black'),
        axis.title = element_text(size=14, color='black'),
        axis.line = element_blank())

```
\
\
\
\

### Realized interedges
\
\
```{r}

co_occurrence_species<- read.csv("co_occurrence_species.csv")

#Maximum potential interlayer links according to species co-occurrence
co_occurrence_tot<-co_occurrence_species %>%  group_by(node_id) %>%  
  mutate(tot_island = sum (n)) %>% 
  summarize(Num_pot_interedge= case_when(tot_island == '1' ~ '0',
                               tot_island == '2' ~ '1',
                               tot_island == '3' ~ '3',
                               tot_island == '4' ~ '6',
                               tot_island == '5' ~ '10',
                               tot_island == '6' ~ '15',
                               tot_island == '7' ~ '21'))%>% unique()  #Potential links according to species co-occurence


co_occurrence_tot$Num_pot_interedge<-as.numeric(co_occurrence_tot$Num_pot_interedge)
pot_interedge<-co_occurrence_tot %>% ungroup() %>% summarize(Pot_interedge = sum(Num_pot_interedge))

#Realized interedges links
dryad_edgelist_complete_ids<- read.csv("dryad_edgelist_complete_ids_islands.csv")
real_interedge<- dryad_edgelist_complete_ids %>% filter(layer_from!=layer_to) %>% 
                summarize(Real_interedges = n())  

interedges_comp<-cbind(pot_interedge,real_interedge, col=1)
interedges_comp2<- pivot_longer(interedges_comp, names_to = "group", values_to = "Count", cols = -col)

interedges_comp2%>%
  ggplot(aes(x=group, y= Count, fill=group))+ geom_bar(stat='identity', alpha= 0.6, color= "black")+ theme_bw()+
  scale_y_continuous(limits = c(0, 500), breaks=seq(0,500,50)) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=14, color='black'),
        axis.title = element_text(size=14, color='black'))
```
\
\
\
\

### Distribution pollinator species across locations
\
\
```{r}

co_occurrence_species<- read.csv("co_occurrence_species.csv")

## Distribution of pollinators
co_occurrence_pol<- co_occurrence_species %>% filter(type=="pollinator") %>% group_by(node_id) %>%  
  mutate(tot_island = sum (n)) %>% arrange(desc(tot_island))

# Convert node_id to an ordered factor (change order that plant appears in the x axis)
co_occurrence_pol$node_id <- as.factor(co_occurrence_pol$node_id)
co_occurrence_pol$node_id <- fct_inorder(co_occurrence_pol$node_id)

co_occurrence_pol%>% 
  ggplot(aes(x=node_id, y= n ,fill= factor(layer_name)))+ geom_bar(stat= "identity")+ theme_classic()+ labs(y="Number of islands", x="Pollinator Species")+
  guides(fill=guide_legend(title="Island"))+ theme(axis.text.x=element_blank())


```
\
\
\
\

### Distribution plant species across locations
\
\

```{r}

co_occurrence_species<- read.csv("co_occurrence_species.csv")

## Distribution of plants
co_occurrence_plants<- co_occurrence_species %>% filter(type=="plant") %>% group_by(node_id) %>%  
  mutate(tot_island = sum (n)) %>% arrange(desc(tot_island))

# Convert node_id to an ordered factor (change order that plant appears in the x axis)
co_occurrence_plants$node_id<- as.factor(co_occurrence_plants$node_id)
co_occurrence_plants$node_id <- fct_inorder(co_occurrence_plants$node_id)

co_occurrence_plants%>% 
  ggplot(aes(x=node_id, y= n ,fill= factor(layer_name)))+ geom_bar(stat= "identity")+ theme_classic()+ labs(y="Number of islands", x="Plant species ID")+ theme(axis.text.x=element_text(size =7))+
  guides(fill=guide_legend(title="Island"))



```
\
\
\
\


### Prop. sps in each island that integrate each module
\
\

```{r}

#Calculate the number and proportion of species in each module
Prop_sp_in_island <- read.csv("Prop_sp_in_island.csv")

ggplot(Prop_sp_in_island, aes(x = module, y = layer_name, fill=Prop_sp )) +
  geom_tile(color='white') +
  theme(panel.grid = element_blank(),panel.background = element_blank(), 
    axis.text.x = element_text(size=12, colour = "black"),
        axis.text.y=element_text(size=13, colour = "black"), axis.title = element_text(size=14),
        legend.text=element_text(size=11.5),legend.title =element_text(size=12),
    axis.line = element_line(colour = "black")) +
  scale_fill_viridis(name = "Prop. sp",limits = c(0, 0.50)) +
  scale_x_continuous(breaks=seq(1,88,4)) +
  scale_y_discrete(limits = c("Hierro","Gomera","TenerifeTeno","TenerifeSouth","GranCanaria","Fuerteventura","WesternSahara"))+
  labs(x='Module ID', y="Locations")

```
\
\
\
\


### Number of modules integrated by one physical node
\
\
```{r}

modules_dryad_multilayer <- read.csv("modules_in_network_islands_as_layers.csv") 

##-- Check if modules are integrated by the same species across layers
same_species_mod<-modules_dryad_multilayer  %>% select(-flow,-species) %>% 
  group_by(module) %>% distinct(node_id) %>% count() #all modules have two or more different species

df<-data.frame(Group= c("Self-species per module","Multi-species per module"),
               Count = c(0,30))

  df %>% ggplot(aes(x=Group, y= Count, fill=Group))+ geom_bar(stat='identity', alpha= 0.6, color= "black")+ theme_bw()+
  scale_y_continuous(limits = c(0, 50), breaks=seq(0,50,10)) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=10, color='black'),
        axis.title = element_text(size=10, color='black'))
```
\
\
\
\


# Results {.tabset}
\
