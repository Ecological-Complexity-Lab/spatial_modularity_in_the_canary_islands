---
title: Drivers of structure distance decay in a spatial multilayer plant-pollinator
  network
output:
  html_document:
    toc: yes
    toc_float: yes
    collapse: no
    number_sections: yes
    code_folding: hide
    theme: united
    highlight: tango
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "asis", message=FALSE, warning=FALSE, cache=FALSE, eval = TRUE, dev = c('png'), out.width = '100%', out.height='40%')
```


```{r load libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(infomapecology)
library(igraph)
library(bipartite)
library(tidyverse)
library(magrittr)
library(betalink)
library(readxl)
library(ggalluvial)
library(scatterpie)
library(reshape2)
library(ggforce)
library(ggmap)
library(ggraph)
library(ggpubr)
library(viridis)
rm(list=ls())
```

\
\
\

# Distance decay
A well-documented phenomenon in nature is distance decayâ€” the decreasing species similarity between two locations
as the distance between them increase. However, studies addressing distance decay in community structure are rare. 
\
\
\

# Goal
We studied how distance affects the modular structure of a multilayer plant-pollinator network in the Canary Islands. In addition, we performed null models that explicitly control different components to disentangle the mechanisms behind distance decay patterns.
\
\
\

# Methods
\

## Data
\
The study was conducted in The Canary Islands, where six islands and one location on the mainland were sampled. Distances between locations ranged from 52 to 450 kilometers. On each location, pollinator-plant interactions were recorded in two adjacent sites (from 50 to 500 meters apart) for a total of 14 sites. We aggregated data from any two adjacent sites on an island or mainland because we were interested in between-location spatial scale. 

```{r}
library(knitr)
Description <- read_excel("Location_description.xlsx")
kable(Description, align=c(rep('c',times=7)))

```
\
\
\

\

## Plant-pollinator multilayer network {.tabset}

Contained four components:

1. Seven layers (six islands and the mainland).

2. Two sets of nodes representing pollinator and plant species.

3. Intralayer directed weighted links representing pollinator-plant interactions within layers.

4. Interlayer weighted links connecting any species i to itself between two layers when they shared at least one partner. Greater values indicate higher similarity of partners between the same species across locations. 
\
\
\

### Information of layers
\
\
```{r}
library(knitr)
Description <- read_excel("Location_description.xlsx", sheet = 2)
kable(Description, align=c(rep('c',times=7)))
```
\
\
\
\
\

### Distribution of intra and interlayer links
\
\
```{r}

intra_inter_data_for_distibution <- read.csv("intra_inter_data_for_distibution_islands_as_layers.csv")

intra_inter_data_for_distibution %>%
  ggplot(aes(x=values, fill=group))+ geom_histogram(position= "identity", alpha= 0.6, color= "black")+ theme_bw()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=14, color='black'),
        axis.title = element_text(size=14, color='black'),
        axis.line = element_blank())

```
\
\
\
\

### Realized interedges
\
\
```{r}

co_occurrence_species<- read.csv("co_occurrence_species.csv")

#Maximum potential interlayer links according to species co-occurrence
co_occurrence_tot<-co_occurrence_species %>%  group_by(node_id) %>%  
  mutate(tot_island = sum (n)) %>% 
  summarize(Num_pot_interedge= case_when(tot_island == '1' ~ '0',
                               tot_island == '2' ~ '1',
                               tot_island == '3' ~ '3',
                               tot_island == '4' ~ '6',
                               tot_island == '5' ~ '10',
                               tot_island == '6' ~ '15',
                               tot_island == '7' ~ '21'))%>% unique()  #Potential links according to species co-occurence


co_occurrence_tot$Num_pot_interedge<-as.numeric(co_occurrence_tot$Num_pot_interedge)
pot_interedge<-co_occurrence_tot %>% ungroup() %>% summarize(Pot_interedge = sum(Num_pot_interedge)*2)

#Realized interedges links
dryad_edgelist_complete_ids<- read.csv("dryad_edgelist_complete_ids_islands.csv")
real_interedge<- dryad_edgelist_complete_ids %>% filter(layer_from!=layer_to) %>% 
                summarize(Real_interedges = n())  

interedges_comp<-cbind(pot_interedge,real_interedge, col=1)
interedges_comp2<- pivot_longer(interedges_comp, names_to = "group", values_to = "Count", cols = -col)

interedges_comp2%>%
  ggplot(aes(x=group, y= Count, fill=group))+ geom_bar(stat='identity', alpha= 0.6, color= "black")+ theme_bw()+
  scale_y_continuous(limits = c(0, 900), breaks=seq(0,900,100)) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=14, color='black'),
        axis.title = element_text(size=14, color='black'))
```
\
\
\
\

### Distribution pollinator species across locations
\
\
```{r}

co_occurrence_species<- read.csv("co_occurrence_species.csv")

## Distribution of pollinators
co_occurrence_pol<- co_occurrence_species %>% filter(type=="pollinator") %>% group_by(node_id) %>%  
  mutate(tot_island = sum (n)) %>% arrange(desc(tot_island))

# Convert node_id to an ordered factor (change order that plant appears in the x axis)
co_occurrence_pol$node_id <- as.factor(co_occurrence_pol$node_id)
co_occurrence_pol$node_id <- fct_inorder(co_occurrence_pol$node_id)

co_occurrence_pol%>% 
  ggplot(aes(x=node_id, y= n ,fill= factor(layer_name)))+ geom_bar(stat= "identity")+ theme_classic()+ labs(y="Number of islands", x="Pollinator Species")+
  guides(fill=guide_legend(title="Island"))+ theme(axis.text.x=element_blank())


```
\
\
\
\

### Distribution plant species across locations
\
\

```{r}

co_occurrence_species<- read.csv("co_occurrence_species.csv")

## Distribution of plants
co_occurrence_plants<- co_occurrence_species %>% filter(type=="plant") %>% group_by(node_id) %>%  
  mutate(tot_island = sum (n)) %>% arrange(desc(tot_island))

# Convert node_id to an ordered factor (change order that plant appears in the x axis)
co_occurrence_plants$node_id<- as.factor(co_occurrence_plants$node_id)
co_occurrence_plants$node_id <- fct_inorder(co_occurrence_plants$node_id)

co_occurrence_plants%>% 
  ggplot(aes(x=node_id, y= n ,fill= factor(layer_name)))+ geom_bar(stat= "identity")+ theme_classic()+ labs(y="Number of islands", x="Plant species ID")+ theme(axis.text.x=element_text(size =7))+
  guides(fill=guide_legend(title="Island"))



```
\
\
\
\


### Prop. sps of each island that integrate each module
\
\

```{r}

#Calculate the number and proportion of species in each module
Prop_sp_in_island <- read.csv("Prop_sp_in_island.csv")

ggplot(Prop_sp_in_island, aes(x = module, y = layer_name, fill=Prop_sp )) +
  geom_tile(color='white') +
  theme(panel.grid = element_blank(),panel.background = element_blank(), 
    axis.text.x = element_text(size=12, colour = "black"),
        axis.text.y=element_text(size=13, colour = "black"), axis.title = element_text(size=14),
        legend.text=element_text(size=11.5),legend.title =element_text(size=12),
    axis.line = element_line(colour = "black")) +
  scale_fill_viridis(name = "Prop. sp",limits = c(0, 0.50)) +
  scale_x_continuous(breaks=seq(1,88,4)) +
  scale_y_discrete(limits = c("Hierro","Gomera","TenerifeTeno","TenerifeSouth","GranCanaria","Fuerteventura","WesternSahara"))+
  labs(x='Module ID', y="Locations")

```
\
\
\
\


### Number of modules integrated by one physical node
\
\
```{r}

modules_dryad_multilayer <- read.csv("modules_in_network_islands_as_layers.csv") 

##-- Check if modules are integrated by the same species across layers
same_species_mod<-modules_dryad_multilayer  %>% select(-flow,-species) %>% 
  group_by(module) %>% distinct(node_id) %>% count() #all modules have two or more different species

df<-data.frame(Group= c("Self-species per module","Multi-species per module"),
               Count = c(10,41))

  df %>% ggplot(aes(x=Group, y= Count, fill=Group))+ geom_bar(stat='identity', alpha= 0.6, color= "black")+ theme_bw()+
  scale_y_continuous(limits = c(0, 50), breaks=seq(0,50,10)) +
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=10, color='black'),
        axis.title = element_text(size=10, color='black'))
```
\
\
\
\


# Results {.tabset}
\
\

## Distance decay - Empirical 
We observed modules distance decay in the empirical data ($R^2$ = 0.538, P < 0.001), which indicates that islands tended to share less modules with increasing distance.

```{r}

islands_turnover_with_distnace_empirical<-read.csv("islands_turnover_with_distnace_empirical.csv")

islands_turnover_with_distnace_empirical %>%
  ggplot(aes(x=distance_in_km, y=turnover))+
  geom_point(color = "#FB3B1E")+ 
  scale_x_continuous()+ stat_smooth(method= "lm", se=F, color = "#FB3B1E")+
  theme(axis.title=element_text(size=22))+theme(axis.text.x=element_text(size=15))+
  theme(axis.text.y=element_text(size=15))+
  labs(x="Distance in Km", y="Jaccard Similarity")+ theme_bw()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=14, color='black'),
        axis.title = element_text(size=14, color='black'),
        axis.line = element_blank())
```
\
\
\


## Structure distande decay - Species turnover 
Redistributing pollinator and pollinator and plant species among locations broke structure distance decay ($R^2_{M_1^A}$= 0.123, P = 0.066; $R^2_{M_1^{AP}}$ = 0.049, P = 0.834) but not the redistribution of plants ($R^2_{M_1^P}$ = 0.319, P < 0.005).
\
\

```{r}
jaccard_similarity_layer_empirical_and_null_km <- read.csv("jaccard_similarity_layer_empirical_and_null_km_islands_m1.csv")

jaccard_similarity_layer_empirical_and_null_km %>% 
  ggplot(aes(x= mean_dist_in_km, y= ave, group= type, color= type))+
  geom_point()+ geom_errorbar(aes(ymin= ave-sd, ymax= ave+sd))+
  labs(x="Distance (Km)", y="Jaccard Similarity")+  
  scale_color_manual(name = "Null Model",  labels = c("E",expression("M"[1]^AP), expression("M"[1]^P),
                     expression("M"[1]^A)),values = c("#FB3B1E", "#15B7BC", 
                                                                                        "#72A323", "#BE75FA" )) +

  theme_classic()+ geom_smooth(method= "lm", se=F)+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))
 
```
\
\

Similarly, the amount of structure variation explained by distance between locations was lower when we shuffled pollinators and both plants and pollinators than in the empirical network (P < 0.001). Altogether, these results indicate that the spatial distribution of pollinator species contribute to the distance decay pattern found in the empirical network. 
\
\

```{r}

rqsuares_M1_all <- read.csv("rqsuares_M1_all.csv")
correlation_empirical_pols <- read.csv("correlation_empirical_pols.csv")


rqsuares_M1_all$type <- factor(rqsuares_M1_all$type, levels = c("shuf_plants","shuf_pollinators","shuf_both"))


rqsuares_M1_all %>% 
  ggplot(aes(x = rsquared, fill = type))+ 
  geom_density(alpha = 0.5)+ 
  geom_vline(xintercept = correlation_empirical_pols$rsquared, linetype = "dashed", color = "#FB3B1E")+
  labs(x= expression("R"^2), y="Density")+  
  scale_fill_manual(name = "Null Model",  labels = c(expression("M"[1]^P),expression("M"[1]^A),
                                                     expression("M"[1]^AP)), values = c("#72A323","#A44CD3", "#15B7BC"))+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))
```
\
\

```{r}

rqsuares_M1_all <- read.csv("rqsuares_M1_all.csv")
correlation_empirical_pols <- read.csv("correlation_empirical_pols.csv")

rqsuares_M1_all$type <- factor(rqsuares_M1_all$type, levels = c("shuf_plants","shuf_pollinators","shuf_both"))

rqsuares_M1_all %>% 
  ggplot(aes(x = slope, fill = type))+ 
  geom_density(alpha = 0.5)+ 
  geom_vline(xintercept = correlation_empirical_pols$slope, linetype = "dashed", color = "#FB3B1E")+
  labs(x= "Slope", y="Density")+  
  scale_fill_manual(name = "Null Model",  labels = c(expression("M"[1]^P),expression("M"[1]^A),
                                                     expression("M"[1]^AP)), values = c("#72A323","#A44CD3", "#15B7BC"))+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))
```
```{r}
library(knitr)
Description <- read_excel("Table_models.xlsx", sheet = 2)
kable(Description, align=c(rep('c',times=6)), digits = c(0,3,5,3,3,0), format.args = list(scientific = FALSE))

```
\
\


## Structure distande decay - Interaction rewiring
Shuffling interactions between locations did not break the distance decay pattern in structure ($R^2_{M_2}$ = 0.766, P < 0.001), suggesting that interaction rewiring does not contribute substantially to the pattern found.
\
\

```{r}
jaccard_similarity_layer_empirical_and_null_km_interactions <- read.csv("jaccard_similarity_layer_empirical_and_null_km_interactions_islands.csv") 

jaccard_similarity_layer_empirical_and_null_km_interactions %>% 
  ggplot(aes(x= mean_dist_in_km, y= ave, group= type, color= type))+
  geom_point()+ geom_errorbar(aes(ymin= ave-sd, ymax= ave+sd))+ theme_classic()+ geom_smooth(method= "lm", se=F)+
  scale_color_manual (name = "Null Model", labels = c("E",expression("M"[2])),
                      values = c("#FB3B1E",  "#E6AB02" ))+
  labs(x="Distance (Km)", y="Jaccard Similarity")+  #stat_cor(aes(label = ..rr.label..))+
  
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))
```
\
\

Similarly, it did not affect the overall structure variation explained by distance (P = 0.066)
\
\

```{r}
correlation_empirical_interactions <- read.csv("correlation_empirical.csv")
iteration_correlation_interactions <- read.csv("iteration_correlation_interactions_islands.csv")
iteration_correlation_interactions2<-iteration_correlation_interactions %>% mutate(Type = "null_int")

iteration_correlation_interactions2 %>% ggplot(aes(x = rsquared, fill= Type))+ 
  geom_density(alpha = 0.6)+ 
  geom_vline(xintercept = correlation_empirical_interactions$rsquared, linetype = "dashed", color = "#FB3B1E") +
  labs(x= expression("R"^2), y="Density")+  
  scale_fill_manual(name = "Null Model",  label = expression("M"^2), values= "#E6AB02")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))

```
\
\

```{r}
correlation_empirical_interactions <- read.csv("correlation_empirical.csv")
iteration_correlation_interactions <- read.csv("iteration_correlation_interactions_islands.csv")
iteration_correlation_interactions2<-iteration_correlation_interactions %>% mutate(Type = "null_int")

iteration_correlation_interactions2 %>% ggplot(aes(x = slope, fill= Type))+ 
  geom_density(alpha = 0.6)+ 
  geom_vline(xintercept = correlation_empirical_interactions$slope, linetype = "dashed", color = "#FB3B1E") +
  labs(x= "Slope", y="Density")+  
  scale_fill_manual(name = "Null Model",  label = expression("M"^2), values= "#E6AB02")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))

```
\
\

```{r}
library(knitr)
Description <- read_excel("Table_models.xlsx", sheet = 3)
kable(Description, align=c(rep('c',times=6)), digits = c(0,3,5,3,3,0), format.args = list(scientific = FALSE))

```
\
\


## Structure distande decay - Local Factors
Shuffling interactions within locations did not break the distance decay pattern in structure ($R^2_{M_3}$ = 0.60, P < 0.001), suggesting that local factors does not contribute substantially to the pattern found. 
\
\

```{r}
jaccard_similarity_layer_empirical_and_null_km_classic <- read.csv("jaccard_similarity_layer_empirical_and_null_km_classic_islands.csv") #need to read this to run next part

jaccard_similarity_layer_empirical_and_null_km_classic %>% 
  ggplot(aes(x= mean_dist_in_km, y= ave, group= type, color= type))+
  geom_point()+ geom_errorbar(aes(ymin= ave-sd, ymax= ave+sd))+ theme_classic()+ geom_smooth(method= "lm", se=F)+
  scale_color_manual (name = "Null Model", labels = c("E",expression("M"[3])),
                      values = c("#FB3B1E","#FA86F2"))+
  labs(x="Distance (Km)", y="Jaccard Similarity")+  #stat_cor(aes(label = ..rr.label..))+
  
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))
```
\
\

However, it had a significant effect on the overall structure variation explained by distance (P < 0.005) and reduced the magnitude of the effect of distance decay in structure (Slope$_{M_3}$ = -0.000053 vs. Slope$_{Empirical}$ = -0.001).
\
\

```{r}
correlation_empirical_classic <- read.csv("correlation_empirical.csv")
iteration_correlation_classic <- read.csv("iteration_correlation_classic_islands.csv")
iteration_correlation_classic2<-iteration_correlation_classic %>% mutate(Type = "null_class")

iteration_correlation_classic2 %>% ggplot(aes(x = rsquared, fill= Type))+ 
  geom_density(alpha = 0.6)+ 
  geom_vline(xintercept = correlation_empirical_classic$rsquared, linetype = "dashed", color = "#FB3B1E") +
  labs(x= expression("R"^2), y="Density")+  
  scale_fill_manual(name = "Null Model",  label = expression("M"^3), values= "#FA86F2")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))

```
\
\

```{r}
correlation_empirical_classic <- read.csv("correlation_empirical.csv")
iteration_correlation_classic <- read.csv("iteration_correlation_classic_islands.csv")
iteration_correlation_classic2<-iteration_correlation_classic %>% mutate(Type = "null_class")

iteration_correlation_classic2  %>% ggplot(aes(x = slope, fill= Type))+ 
  geom_density(alpha = 0.6)+ 
  geom_vline(xintercept = correlation_empirical_classic$slope, linetype = "dashed", color = "#FB3B1E") +
  labs(x= "Slope", y="Density")+  
  scale_fill_manual(name = "Null Model",  label = expression("M"^3), values= "#FA86F2")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))


```
\
\

```{r}
library(knitr)
Description <- read_excel("Table_models.xlsx", sheet = 4)
kable(Description, align=c(rep('c',times=6)), digits = c(0,3,5,3,3,0), format.args = list(scientific = FALSE))

```
\
\

## Structure distance decay - Changes in partner similarity 
In addition, modifying partner similarity of species across locations ($M_4$) produces a similar pattern of distance decay in modules as the empirical network, suggesting that partner fidelity is not an important driver of distance decay in structure.
\
\

```{r}
jaccard_similarity_empirical_and_fixed_km <- read.csv("sensitivity_nullmodel4.csv")

cols2 = c("#7DB0DDFF","#5BB7D3FF", "#3FBBC4FF", "#39BEB1FF", "#4EBE9CFF","#6ABC88FF", "#86B875FF", "#9FB368FF",
         "#B5AD64FF", "#C7A76CFF","#FB3B1E")

jaccard_similarity_empirical_and_fixed_km %>% 
  ggplot(aes(x= ave_dist_in_km , y= ave, group= trial, color= trial))+
  geom_point()+ theme_classic()+ geom_smooth(method= "lm", se=F)+
  scale_color_manual(values=cols2, name ="Interedges weight")+
  theme(axis.title=element_text(size=22))+theme(axis.text.x=element_text(size=15))+
  theme(axis.text.y=element_text(size=15))+ theme(legend.title = element_text(size = 13), legend.text = element_text(size = 13))+
  labs(x="Distance in Km", y="Jaccard Similarity")+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=14, color='black'),
        axis.title = element_text(size=14, color='black'),
        axis.line = element_blank()) 
```
